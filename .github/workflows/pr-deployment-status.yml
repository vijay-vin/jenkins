name: Post Deployment Status Link

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

# Without this, GitHub may reject the commit status POST!
permissions:
  statuses: write        # allow posting commit statuses
  contents: read       

jobs:
  post-status:
    runs-on: ubuntu-latest

    steps:
      - name: Extract PR commit SHA and branch
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          echo "BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
          echo "REPO_FULL=${{ github.repository }}" >> $GITHUB_ENV
          echo "HEAD_REPO_FULL=${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_ENV

      - name: Build Jenkins Deployment URL
        shell: bash
        run: |
          # Jenkins job users will click to open "Build with Parameters"
          # JOB_NAME="vj-ai-services-pr-listener"
          # JOB_NAME="vijayv_pipelines/vj-pr-preview-pipeline-copy"
          JOB_NAME="vijayv/job/vj-pr-preview-pipeline-copy"
          JENKINS_URL="http://10.20.178.84:8080"

          # Default ApplicationList value
          APP_LIST="rag-dev"

          # pass this to downstream pipeline, so that it can update the check status if needed
          UPDATE_STATUS=true

          # Add encoding
          COMMIT_Q=$(printf %s "$COMMIT_SHA" | jq -sRr @uri)     
          PR_Q=$(printf %s "$PR_NUMBER" | jq -sRr @uri)
          APP_Q=$(printf %s "$APP_LIST" | jq -sRr @uri)
          REPO_Q=$(printf %s "$REPO_FULL" | jq -sRr @uri)
          HEAD_REPO_Q=$(printf %s "$HEAD_REPO_FULL" | jq -sRr @uri)
   
          # Construct Jenkins Build-with-Parameters URL
          DEPLOY_URL="${JENKINS_URL}/job/${JOB_NAME}/parambuild/?COMMIT=${COMMIT_Q}&CHECKOUT=${PR_Q}&ApplicationList=${APP_Q}&REPO_FULL=${REPO_Q}&HEAD_REPO_FULL=${HEAD_REPO_Q}&updateGitStatus=${UPDATE_STATUS}"

          echo "DEPLOY_URL=${DEPLOY_URL}" >> $GITHUB_ENV
          echo "Generated Deployment URL: ${DEPLOY_URL}"

      - name: Post GitHub Commit Status (Pending)
        env:
          GH_TOKEN: ${{ github.token }}   # built-in GitHub token
          # GH_TOKEN: ${{ secrets.TokenForJenkins }}  # my personal token
        run: |
          echo "Posting pending status to GitHub..."
          curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
                   -H "Accept: application/vnd.github+json" \
                   -X POST \
                   -d "{
                     \"state\": \"pending\",
                     \"target_url\": \"${DEPLOY_URL}\",
                     \"description\": \"Click to open Jenkins â†’ Build with Parameters\",
                     \"context\": \"Manual Deployment\"
                   }" \
                   "https://api.github.com/repos/${{ github.repository }}/statuses/${COMMIT_SHA}"
          echo "Status posted successfully."
